name: r-devel-daily.yml

on:
  workflow_dispatch:
  schedule:
    - cron:  '55 6 * * *'

jobs:

  matrix:
    runs-on: ubuntu-latest
    name: Setup
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - id: set-matrix
      run: |
        matrix=$(echo '
        [ { "r": "devel" },
          { "r": "next" } ]
        ' | jq -c)
        echo "matrix=$matrix"
        echo "matrix=$matrix" >> $GITHUB_OUTPUT

  amd64:
    needs: matrix
    uses: ./.github/workflows/build-one.yml
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.matrix.outputs.matrix) }}
    with:
      platform: 'amd64'
      runs-on: 'ubuntu-latest'
      rversion: ${{ matrix.config.r }}
    secrets: inherit

  arm64:
    needs: matrix
    uses: ./.github/workflows/build-one.yml
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.matrix.outputs.matrix) }}
    with:
      platform: 'arm64'
      runs-on: 'ubuntu-24.04-arm'
      rversion: ${{ matrix.config.r }}
    secrets: inherit

  manifest:
    needs: [matrix, amd64, arm64]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.matrix.outputs.matrix) }}
    steps:
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}
    - run: |
        # Create the manifest lists and push them to the respective registries
        for tag in `echo ${{ needs.amd64.outputs.tags }} | tr ',' ' '`; do
          docker buildx imagetools create -t $tag \
            ghcr.io/r-hub/r-minimal/r-minimal:${{ matrix.config.r }}-amd64 \
            ghcr.io/r-hub/r-minimal/r-minimal:${{ matrix.config.r }}-arm64;
        done
      shell: bash

  readme:
    name: Update README
    runs-on: ubuntu-latest
    needs: manifest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 10

    - name: Update README
      uses: ./actions/readme-build
